pipeline {
    agent any
    
    parameters {
        choice(
            name: 'BRANCH',
            choices: ['main', 'vikas_dev', 'siddharth-dev', 'feature/excel-row-wise-storage', 'formula-processing'],
            description: 'Select branch to deploy'
        )
    }
    
    environment {
        SERVER_HOST = '65.0.236.144'
        SERVER_USER = 'ubuntu'
        SSH_KEY = credentials('ssh-key')
        PROJECT_DIR = '/home/ubuntu/LaughingBuddha'
        SERVICE_NAME = 'uploader'
        GIT_BRANCH = "${params.BRANCH}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üì¶ Checking out code from branch: ${GIT_BRANCH}..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${GIT_BRANCH}"]],
                        userRemoteConfigs: [[url: 'https://github.com/sidm01890/LB-Uploader.git']],
                        extensions: [[$class: 'CleanCheckout']]
                    ])
                }
            }
        }
        
        stage('Verify Changes') {
            steps {
                script {
                    echo "üîç Verifying changes from branch: ${GIT_BRANCH}..."
                    sh '''
                        git log --oneline -5
                        git status
                    '''
                }
            }
        }
        
        stage('Deploy to Server') {
            steps {
                script {
                    echo "üöÄ Deploying ${SERVICE_NAME} to server..."
                    try {
                        sshagent([SSH_KEY]) {
                            sh """
                                ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${SERVER_USER}@${SERVER_HOST} << 'DEPLOY_EOF'
                                    set -e  # Exit on error
                                    cd ${PROJECT_DIR}
                                    
                                    echo "üì• Pulling latest changes in Uploader directory..."
                                    cd Uploader || { echo "‚ùå Uploader directory not found"; exit 1; }
                                    git fetch origin || { echo "‚ùå Git fetch failed"; exit 1; }
                                    git checkout ${GIT_BRANCH} || { echo "‚ùå Git checkout failed"; exit 1; }
                                    git pull origin ${GIT_BRANCH} || { echo "‚ùå Git pull failed"; exit 1; }
                                    
                                    echo "üîÑ Going back to project root..."
                                    cd ..
                                    
                                    echo "üõë Stopping and removing container..."
                                    docker compose -f docker-compose.staging.yml stop ${SERVICE_NAME} || echo "Container not running"
                                    docker compose -f docker-compose.staging.yml rm -f ${SERVICE_NAME} || echo "Container not found"
                                    
                                    echo "üî® Rebuilding image..."
                                    docker compose -f docker-compose.staging.yml build ${SERVICE_NAME} || { echo "‚ùå Build failed"; exit 1; }
                                    
                                    echo "üöÄ Starting container..."
                                    docker compose -f docker-compose.staging.yml up -d ${SERVICE_NAME} || { echo "‚ùå Start failed"; exit 1; }
                                    
                                    echo "‚è≥ Waiting for startup (25 seconds)..."
                                    sleep 25
                                    
                                    echo "‚úÖ Verifying deployment..."
                                    docker ps | grep ${SERVICE_NAME} || { echo "‚ùå Container not running"; exit 1; }
                                    docker logs ${SERVICE_NAME} | tail -10
                                DEPLOY_EOF
                            """
                        }
                    } catch (Exception e) {
                        echo "‚ùå Deployment failed: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo "‚úÖ Verifying deployment..."
                    sshagent([SSH_KEY]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << 'VERIFY_EOF'
                                # Check container status
                                docker ps | grep ${SERVICE_NAME}
                                
                                # Test health endpoint
                                docker exec ${SERVICE_NAME} curl -s http://localhost:8010/api/health || echo "Health check failed"
                                
                                # Check MongoDB connection
                                docker exec ${SERVICE_NAME} python3 -c "from app.core.config import config; print(f'MongoDB: {config.mongodb.host}')" || echo "Config check failed"
                            VERIFY_EOF
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ Deployment successful!"
        }
        failure {
            echo "‚ùå Deployment failed!"
        }
    }
}

